steps:
  - name: gcr.io/cloud-builders/docker
    id: Build
    args:
      - build
      - '--no-cache'
      - '-t'
      - "${_IMAGE_NAME}:$COMMIT_SHA"
      - '-t'
      - "${_IMAGE_NAME}:latest"
      - .
      - '-f'
      - ./apps/<%= name %>/Dockerfile
  - name: gcr.io/cloud-builders/docker
    id: Push
    args:
      - push
      - "${_IMAGE_NAME}:$COMMIT_SHA"
  - name: gcr.io/cloud-builders/docker
    id: PushLatest
    args:
      - push
      - "${_IMAGE_NAME}:latest"

images:
  - "${_IMAGE_NAME}:$COMMIT_SHA"
  - "${_IMAGE_NAME}:latest"

options:
  substitutionOption: ALLOW_LOOSE

substitutions:
  _SERVICE_NAME: <%= name %>
  _AR_HOSTNAME: europe-west3-docker.pkg.dev
  _AR_REPOSITORY: docker
  _IMAGE_NAME: "${_AR_HOSTNAME}/${PROJECT_ID}/${_AR_REPOSITORY}/${REPO_NAME}/${_SERVICE_NAME}"

artifacts:
  images:
    - "${_IMAGE_NAME}:$COMMIT_SHA"
    - "${_IMAGE_NAME}:latest"

timeout: '900s'
